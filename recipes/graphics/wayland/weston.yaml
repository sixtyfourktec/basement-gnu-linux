inherit: [meson, wayland-scanner, init]

metaEnvironment:
    PKG_VERSION: "15.0.0"
    PKG_LICENSE: "MIT"

depends:
    - libs::libpng-dev
    - virtual::libs::libjpeg-dev
    - virtual::libs::libegl-dev
    - virtual::libs::libgles-dev
    - virtual::libs::libdrm-dev
    - libs::libxkbcommon-dev
    - libs::libinput-dev
    - libs::pixman-dev
    - libs::cairo-dev
    - libs::pango-dev
    - libs::libdisplay-info-dev
    - devel::lua-dev
    - core::seatd-libseat-dev
    - graphics::wayland::wayland-dev
    - graphics::wayland::wayland-protocols

    - use: []
      depends:
          - libs::libpng-tgt
          - virtual::libs::libjpeg-tgt
          - virtual::libs::libegl-tgt
          - virtual::libs::libgles-tgt
          - virtual::libs::libdrm-tgt
          - libs::libxkbcommon-tgt
          - libs::libinput-tgt
          - libs::pixman-tgt
          - libs::cairo-tgt
          - libs::pango-tgt
          - libs::libdisplay-info-tgt
          - core::seatd-libseat-tgt
          - graphics::wayland::wayland-tgt

checkoutSCM:
    scm: url
    url: https://gitlab.freedesktop.org/wayland/weston/-/releases/${PKG_VERSION}/downloads/weston-${PKG_VERSION}.tar.xz
    digestSHA1: 0ddaae77c58d13afbfb22380a1ded691127fb7c4
    stripComponents: 1

buildScript: |
    mesonBuild $1 \
        -Ddoc=false \
        -Dtest-junit-xml=false \
        -Dremoting=false \
        -Dbackend-x11=false \
        -Dbackend-vnc=false \
        -Dbackend-rdp=false \
        -Dbackend-pipewire=false \
        -Dbackend-headless=false \
        -Dxwayland=false \
        -Dsystemd=false \
        -Dpipewire=false \
        -Dimage-webp=false \
        -Dwcap-decode=false \
        -Dcolor-management-lcms=false \
        -Dtools=calibrator,debug,info,terminal,touch-calibrator \
        -Dsimple-clients=all \
        -Ddemo-clients=true \
        -Dshell-desktop=true \
        -Dshell-ivi=true \
        -Dbackend-drm=true \
        -Drenderer-vulkan=false \
        -Drenderer-gl=true

        # add init script
        if initIsAnySysvinit; then
            # install profile file
            install -D -m 0644 $<@weston/weston.sh@> \
                install/etc/profile.d/weston.sh
            install -D -m 0755 $<@weston/S80weston.sh@> \
                install/etc/init.d/S80weston.sh
        fi

multiPackage:
    "":
        depends:
            - name: graphics::wayland::weston-libweston-tgt
              use: []
        packageScript: mesonPackageBin
        provideDeps: [ "*-tgt" ]

    libweston:
        multiPackage:
            dev:
                packageScript: |
                    mesonPackageDev "$1" \
                        "/usr/" "/usr/share/" \
                        "/usr/share/libweston-14/" \
                        "/usr/share/libweston-14/protocols/"
                provideDeps: [ "*-dev" ]

            tgt:
                packageScript: mesonPackageLib
                provideDeps: [ "*-tgt" ]
